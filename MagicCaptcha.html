<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Captcha</title>
  <style>
    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .captcha-container {
      margin-bottom: 10px;
    }
    .form-container {
      margin-left: 20px;
    }
    #timerCanvas {
      margin-left: 20px;
      margin-top: 10px;
    }
  </style>
</head>

<body>
<div class="container">
  <h3>CAPTCHA</h3>
  <div class="captcha-container">
    <canvas class="canvas" id="dessin" width="300" height="160"></canvas>
  </div>
  <div class="form-container">
    <label for="input">Entrez : </label><input id="input" type="text"/>
    <button id="bouton">Validez</button>
  </div>
  <canvas id="timerCanvas" width="100" height="100"></canvas>
</div>

<script type="text/javascript">
  var canvas = document.getElementById("dessin");
  var contexte = canvas.getContext("2d");
  var valeurAleatoire;
  var valeurSaisie = document.getElementById('input');
  var isOk = document.getElementById('p2');
  var timerCanvas = document.getElementById('timerCanvas');
  var timer;

  function initialiserCaptcha() {
    valeurAleatoire = Math.floor(Math.random() * (9999 - 1000 + 1) + 1000);
    var chiffres = valeurAleatoire.toString().split('');
    contexte.clearRect(0, 0, canvas.width, canvas.height);
    var colonneWidth = canvas.width / 4; // c'est la largeur de chaque colonne
    var rectHeight = 160;
    contexte.font = '40px serif';

    // Dessiner les chiffres dans chaque colonne
    for (var i = 0; i < chiffres.length; i++) {
        var chiffre = chiffres[i];
        var colonneCenterX = colonneWidth * i + colonneWidth / 2;
        var colonneCenterY = rectHeight / 2;
        var maxSize = Math.min(colonneWidth, rectHeight);
        var fontSize = maxSize * 0.7; // Pourcentage de la taille maximale que le chiffre peut avoir
        contexte.font = fontSize + 'px serif';
        var textWidth = contexte.measureText(chiffre).width;
        var textHeight = fontSize;

        // Appliquer des déformations sur les chiffres avec une rotation aussi
        contexte.save();
        var degres = Math.random() * 60 - 30; // Rotation aléatoire -> 30 degrés
        contexte.translate(colonneCenterX, colonneCenterY);
        contexte.rotate(degres * Math.PI / 180); // Appliquer la rotation

        // Déformation
        var scaleX = Math.random() * 1.5 + 0.5;
        var scaleY = Math.random() * 1.5 + 0.5; 
        var skewX = Math.random() * 0.3 - 0.15; 
        var skewY = Math.random() * 0.3 - 0.15; 
        contexte.transform(scaleX, skewX, skewY, scaleY, 0, 0); // Appliquer la transformation

        // Déplacer verticalement de manière aléatoire
        var offsetY = Math.random() * 25 - 10; // Décalage vertical aléatoire -> 10 pixels 
        contexte.fillText(chiffre, -textWidth / 2, textHeight / 2 + offsetY);
        contexte.restore();
    }
}

  function reset() {
    initialiserCaptcha();
    isOk.innerHTML = "";
    valeurSaisie.value = "";
    clearInterval(timer);
    chrono();
  }

  function chrono() {
    var tempsRestant = 15;
    var timerContexte = timerCanvas.getContext('2d');
    timer = setInterval(function() {
      if (tempsRestant >= 0) {
        dessinerTimer(timerContexte, tempsRestant); // Appel de la fonction pour dessiner le timer
        tempsRestant--;
      } else {
        clearInterval(timer);
        reset();
      }
    }, 1000);
  }

  // Fonction pour dessiner le timer circulaire
  function dessinerTimer(ctx, tempsRestant) {
    var rayon = 40; // Rayon du cercle
    var x = 50; // x = abcisse = position horizontale 
    var y = 50; // y = ordonné = position verticale  
    var angle = 2 * Math.PI * (tempsRestant / 15);

    ctx.clearRect(0, 0, timerCanvas.width, timerCanvas.height);
    ctx.beginPath();
    ctx.arc(x, y, rayon, -0.5 * Math.PI, -0.5 * Math.PI + angle); // Dessine l'arc du chrono
    ctx.lineWidth = 10;
    ctx.strokeStyle = '#FF0000';
    ctx.stroke();
  }

  document.getElementById('bouton').addEventListener('click', function () {
    if (valeurAleatoire === parseInt(valeurSaisie.value))
      isOk.innerHTML = "Numéro Valide";
    else {
      isOk.innerHTML = "Veuillez réessayer";
    }
  });

  window.onload = function() {
    initialiserCaptcha();
    chrono();
  };

</script>

</body>
</html>
