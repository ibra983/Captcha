<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Captcha</title>
  <style>
    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .captcha-container {
      margin-bottom: 10px;
    }
    .form-container {
      margin-left: 20px;
    }
    #timerCanvas {
      margin-left: 20px;
      margin-top: 10px;
    }
    #dessin {
      border : solid 1px black;
    }
  </style>
</head>

<body>
<div class="container">
  <h3>CAPTCHA</h3>
  <div class="captcha-container">
    <canvas class="canvas" id="dessin" width="180" height="160"></canvas>
  </div>
  <div class="form-container">
    <label for="input">Valeur </label><input id="input" type="text"/>
    <button id="bouton">Vérifier</button>
    <p id="p2"></p>
  </div>
  <canvas id="timerCanvas" width="100" height="100"></canvas>
</div>

<script type="text/javascript">
  var canvas = document.getElementById("dessin");
  var contexte = canvas.getContext("2d");
  var valeurAleatoire;
  var valeurSaisie = document.getElementById('input');
  var isOk = document.getElementById('p2');
  var timerCanvas = document.getElementById('timerCanvas');
  var timer;

  function initialiserCaptcha() {
    valeurAleatoire = Math.floor(Math.random() * (9999 - 1000 + 1) + 1000);
    var chiffres = valeurAleatoire.toString().split('');
    contexte.clearRect(0, 0, canvas.width, canvas.height);
    var colonneWidth = canvas.width / 4; // Largeur de chaque colonne
    var rectHeight = 160;
    contexte.font = '40px serif';

    // Dessiner les chiffres dans chaque colonne
    for (var i = 0; i < chiffres.length; i++) {
      var startX = colonneWidth * i + (colonneWidth - 50) / 2 + 10; // Position horizontale du chiffre dans la colonne avec un décalage de 10 pixels
      var startY = Math.random() * (rectHeight - 40); // Position verticale aléatoire à l'intérieur du rectangle
      startY = Math.min(startY + 50, rectHeight - 50); // Limiter la position verticale pour rester dans le canvas
      contexte.fillText(chiffres[i], startX, startY);
    }
  }

  function reset() {
    initialiserCaptcha();
    isOk.innerHTML = "";
    valeurSaisie.value = "";
    clearInterval(timer);
    chrono();
  }

  function chrono() {
    var tempsRestant = 15;
    var timerContexte = timerCanvas.getContext('2d');
    timer = setInterval(function() {
      if (tempsRestant >= 0) {
        dessinerTimer(timerContexte, tempsRestant); // Appel de la fonction pour dessiner le timer
        tempsRestant--;
      } else {
        clearInterval(timer);
        reset();
      }
    }, 1000);
  }

  // Fonction pour dessiner le timer circulaire
  function dessinerTimer(ctx, tempsRestant) {
    var rayon = 40; // Rayon du cercle
    var x = 50; // Coordonnée x du centre du cercle
    var y = 50; // Coordonnée y du centre du cercle
    var angle = 2 * Math.PI * (tempsRestant / 15); // Le temps total est de 15 secondes

    ctx.clearRect(0, 0, timerCanvas.width, timerCanvas.height);
    ctx.beginPath();
    ctx.arc(x, y, rayon, -0.5 * Math.PI, -0.5 * Math.PI + angle); // Dessine l'arc du timer
    ctx.lineWidth = 10;
    ctx.strokeStyle = '#FF0000';
    ctx.stroke();
  }

  document.getElementById('bouton').addEventListener('click', function () {
    if (valeurAleatoire === parseInt(valeurSaisie.value))
      isOk.innerHTML = "NUMERO VALIDE";
    else {
      isOk.innerHTML = "NUMERO NON VALIDE";
    }
  });

  window.onload = function() {
    initialiserCaptcha();
    chrono();
  };

</script>

</body>
</html>
